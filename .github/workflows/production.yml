name: Production CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
          coverage: none
      
      - name: Check PHP syntax
        run: |
          find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/third_party/*" ! -path "*/system/libraries/*" ! -path "*/cache/*" ! -path "*/logs/*" -exec php -l {} \; | grep -v "No syntax errors"
        continue-on-error: true
      
      - name: Validate critical PHP files
        run: |
          php -l index.php
          php -l b2c/index.php || true
          php -l agent/index.php || true
          php -l supervision/index.php || true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Validate file structure
        run: |
          echo "Validating production file structure..."
          test -f index.php || exit 1
          test -d b2c || exit 1
          test -d system || exit 1
          test -d b2c/config/production || exit 1
      
      - name: Check for production config
        run: |
          echo "Verifying production configuration files exist..."
          ls -la b2c/config/production/ || echo "Production config directory found"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."
          # Check for accidental commits of sensitive files
          if [ -f ".env" ]; then
            echo "Warning: .env file detected"
          fi
          if find . -name "*.key" -o -name "*.pem" -o -name "*secret*" | grep -v node_modules | grep -v vendor; then
            echo "Warning: Potential sensitive files detected"
          fi

  build:
    name: Build Production Package
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create production package
        run: |
          echo "Creating production package..."
          
          # Disable exit on error temporarily to handle tar's exit code 1
          # which occurs when files change during archive creation
          set +e
          
          # Create tar archive with exclusions
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='*.md' \
              --exclude='logs' \
              --exclude='cache' \
              --exclude='b2c/config/development' \
              --exclude='b2c/config/testing' \
              --exclude='node_modules' \
              --exclude='*.log' \
              --exclude='.env' \
              --warning=no-file-changed \
              -czf production-package.tar.gz . 2>&1
          
          TAR_EXIT_CODE=$?
          set -e
          
          # Verify package was created and has content
          # Exit code 1 from tar is acceptable (file changed warning), as long as file exists
          if [ -f production-package.tar.gz ] && [ -s production-package.tar.gz ]; then
            echo "✅ Production package created successfully"
            ls -lh production-package.tar.gz
            echo "Package size: $(du -h production-package.tar.gz | cut -f1)"
          else
            echo "❌ Failed to create production package or package is empty"
            echo "Tar exit code: $TAR_EXIT_CODE"
            exit 1
          fi
          
          # Fail only if tar had a real error (exit code > 1)
          # Exit code 1 means "file changed" which is acceptable
          if [ $TAR_EXIT_CODE -gt 1 ]; then
            echo "❌ Tar failed with exit code: $TAR_EXIT_CODE"
            exit 1
          fi
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-package
          path: production-package.tar.gz
          retention-days: 7

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: production-package
          path: ./artifact
      
      - name: Extract production package
        run: |
          cd ./artifact
          tar -xzf production-package.tar.gz
          cd ..
      
      - name: Setup FTP
        run: |
          # Install lftp for FTP/SFTP deployment
          sudo apt-get update && sudo apt-get install -y lftp
          echo "✅ FTP client installed"
      
      - name: Pre-deployment checks
        run: |
          echo "Running pre-deployment checks..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "FTP Server: ${{ secrets.PROD_FTP_HOST }}"
          echo "Domain: traveltechnology.co.in"
      
      - name: Test FTP connection
        env:
          FTP_HOST: ${{ secrets.PROD_FTP_HOST }}
          FTP_USER: ${{ secrets.PROD_FTP_USER }}
          FTP_PASS: ${{ secrets.PROD_FTP_PASS }}
          FTP_PORT: ${{ secrets.PROD_FTP_PORT || '21' }}
        run: |
          echo "Testing FTP connection..."
          echo "Host: $FTP_HOST"
          echo "Port: $FTP_PORT"
          echo "User: $FTP_USER"
          
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; pwd; quit" || {
            echo "❌ FTP connection failed"
            echo "Please check:"
            echo "1. FTP server address is correct: $FTP_HOST"
            echo "2. FTP port is correct (default: 21, SFTP: 22)"
            echo "3. FTP credentials are correct"
            echo "4. Firewall allows FTP connections from GitHub Actions"
            exit 1
          }
          echo "✅ FTP connection successful"
      
      - name: Deploy to production server via FTP
        env:
          FTP_HOST: ${{ secrets.PROD_FTP_HOST }}
          FTP_USER: ${{ secrets.PROD_FTP_USER }}
          FTP_PASS: ${{ secrets.PROD_FTP_PASS }}
          FTP_PORT: ${{ secrets.PROD_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.PROD_FTP_PATH || '/public_html' }}
        run: |
          echo "Deploying to production server via FTP (optimized for speed)..."
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Create optimized lftp script for faster deployment
          cat > /tmp/ftp_deploy.lftp << 'EOF'
          # Connection settings
          set ftp:ssl-allow no
          set ssl:verify-certificate no
          set ftp:passive-mode yes
          set ftp:list-options -a
          
          # Performance optimizations
          set cmd:fail-exit yes
          set cmd:interactive no
          
          # Network settings
          set net:timeout 20
          set net:max-retries 2
          set net:reconnect-interval-base 3
          
          # Transfer optimizations (parallel transfers for faster speed)
          set mirror:use-pget-n 10
          set xfer:clobber yes
          EOF
          
          # Add connection and deployment commands
          echo "open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST" >> /tmp/ftp_deploy.lftp
          echo "cd $FTP_PATH_FINAL" >> /tmp/ftp_deploy.lftp
          echo "lcd ./artifact" >> /tmp/ftp_deploy.lftp
          echo "mirror --reverse --delete --only-newer --exclude-glob=.git --exclude-glob=.github --exclude-glob=logs/* --exclude-glob=cache/* --exclude-glob=*.log --exclude-glob=.env --exclude-glob=node_modules --exclude-glob=*.md --exclude-glob=b2c/config/development/* --exclude-glob=b2c/config/testing/* . ." >> /tmp/ftp_deploy.lftp
          echo "quit" >> /tmp/ftp_deploy.lftp
          
          echo "Starting FTP deployment..."
          # Execute FTP deployment
          lftp -f /tmp/ftp_deploy.lftp
          
          echo "✅ FTP deployment completed"
      
      - name: Health check after deployment
        env:
          DOMAIN: traveltechnology.co.in
        run: |
          echo "Checking website health..."
          sleep 5  # Wait a few seconds for changes to propagate
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$DOMAIN" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "✅ Website is responding (HTTP $HTTP_CODE)"
          elif [ "$HTTP_CODE" = "500" ]; then
            echo "⚠️  Website returned HTTP 500 error"
            echo "This might indicate a PHP error or configuration issue"
            echo "Please check server logs for more details"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "⚠️  Could not connect to website (timeout or connection refused)"
          else
            echo "⚠️  Website returned HTTP $HTTP_CODE"
          fi
      
      - name: Clear cache via FTP
        env:
          FTP_HOST: ${{ secrets.PROD_FTP_HOST }}
          FTP_USER: ${{ secrets.PROD_FTP_USER }}
          FTP_PASS: ${{ secrets.PROD_FTP_PASS }}
          FTP_PORT: ${{ secrets.PROD_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.PROD_FTP_PATH || '/public_html' }}
        run: |
          echo "Clearing application cache via FTP..."
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Create lftp script to clear cache
          cat > /tmp/ftp_clear_cache.lftp << EOF
          set ftp:ssl-allow no
          set ssl:verify-certificate no
          set cmd:fail-exit no
          open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST
          cd $FTP_PATH_FINAL
          rm -rf cache/* logs/*.log
          quit
          EOF
          
          lftp -f /tmp/ftp_clear_cache.lftp || echo "⚠️ Cache clearing attempted (may not be supported via FTP)"
          echo "✅ Cache clearing completed"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Production deployment successful"
            echo "FTP Server: ${{ secrets.PROD_FTP_HOST }}"
            echo "Domain: traveltechnology.co.in"
            echo "Commit: ${{ github.sha }}"
          else
            echo "❌ Production deployment failed"
            echo "Please check the logs for details"
          fi
      
      - name: Create deployment tag
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$(date +%Y%m%d-%H%M%S)" -m "Production deployment: ${{ github.sha }}"
          git push origin --tags || echo "Failed to push tags"
