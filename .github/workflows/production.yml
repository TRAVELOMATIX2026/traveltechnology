name: Production CI/CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
          coverage: none
      
      - name: Check PHP syntax
        run: |
          find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/third_party/*" ! -path "*/system/libraries/*" ! -path "*/cache/*" ! -path "*/logs/*" -exec php -l {} \; | grep -v "No syntax errors"
        continue-on-error: true
      
      - name: Validate critical PHP files
        run: |
          php -l index.php
          php -l b2c/index.php || true
          php -l agent/index.php || true
          php -l supervision/index.php || true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Validate file structure
        run: |
          echo "Validating production file structure..."
          test -f index.php || exit 1
          test -d b2c || exit 1
          test -d system || exit 1
          test -d b2c/config/production || exit 1
      
      - name: Check for production config
        run: |
          echo "Verifying production configuration files exist..."
          ls -la b2c/config/production/ || echo "Production config directory found"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Check for sensitive files
        run: |
          echo "Checking for sensitive files..."
          # Check for accidental commits of sensitive files
          if [ -f ".env" ]; then
            echo "Warning: .env file detected"
          fi
          if find . -name "*.key" -o -name "*.pem" -o -name "*secret*" | grep -v node_modules | grep -v vendor; then
            echo "Warning: Potential sensitive files detected"
          fi

  build:
    name: Build Production Package
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update database credentials for production
        env:
          PROD_DB_HOST: ${{ secrets.PROD_DB_HOST || 'localhost' }}
          PROD_DB_USERNAME: ${{ secrets.PROD_DB_USERNAME }}
          PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          PROD_DB_NAME: ${{ secrets.PROD_DB_NAME }}
        run: |
          echo "Updating database credentials for production deployment..."
          if [ -f "scripts/update-db-credentials.sh" ]; then
            chmod +x scripts/update-db-credentials.sh
            ./scripts/update-db-credentials.sh production
          else
            echo "⚠️  Database update script not found, skipping credential update"
            echo "Make sure to manually configure database credentials on the server"
          fi
      
      - name: Create production package
        run: |
          echo "Creating production package..."
          
          # Disable exit on error temporarily to handle tar's exit code 1
          # which occurs when files change during archive creation
          set +e
          
          # Create tar archive with exclusions
          tar --exclude='.git' \
              --exclude='.github' \
              --exclude='*.md' \
              --exclude='logs' \
              --exclude='cache' \
              --exclude='b2c/config/development' \
              --exclude='b2c/config/testing' \
              --exclude='node_modules' \
              --exclude='*.log' \
              --exclude='.env' \
              --warning=no-file-changed \
              -czf production-package.tar.gz . 2>&1
          
          TAR_EXIT_CODE=$?
          set -e
          
          # Verify package was created and has content
          # Exit code 1 from tar is acceptable (file changed warning), as long as file exists
          if [ -f production-package.tar.gz ] && [ -s production-package.tar.gz ]; then
            echo "✅ Production package created successfully"
            ls -lh production-package.tar.gz
            echo "Package size: $(du -h production-package.tar.gz | cut -f1)"
          else
            echo "❌ Failed to create production package or package is empty"
            echo "Tar exit code: $TAR_EXIT_CODE"
            exit 1
          fi
          
          # Fail only if tar had a real error (exit code > 1)
          # Exit code 1 means "file changed" which is acceptable
          if [ $TAR_EXIT_CODE -gt 1 ]; then
            echo "❌ Tar failed with exit code: $TAR_EXIT_CODE"
            exit 1
          fi
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: production-package
          path: production-package.tar.gz
          retention-days: 7

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: production-package
          path: ./artifact
      
      - name: Extract production package
        run: |
          cd ./artifact
          tar -xzf production-package.tar.gz
          cd ..
      
      - name: Setup FTP
        run: |
          # Install lftp for FTP/SFTP deployment
          sudo apt-get update && sudo apt-get install -y lftp
          echo "✅ FTP client installed"
      
      - name: Pre-deployment checks
        run: |
          echo "Running pre-deployment checks..."
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"
          echo "FTP Server: ${{ secrets.PROD_FTP_HOST }}"
          echo "Domain: traveltechnology.co.in"
      
      - name: Test FTP connection
        env:
          FTP_HOST: ${{ secrets.PROD_FTP_HOST }}
          FTP_USER: ${{ secrets.PROD_FTP_USER }}
          FTP_PASS: ${{ secrets.PROD_FTP_PASS }}
          FTP_PORT: ${{ secrets.PROD_FTP_PORT || '21' }}
        run: |
          echo "Testing FTP connection..."
          echo "Host: $FTP_HOST"
          echo "Port: $FTP_PORT"
          echo "User: $FTP_USER"
          
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; pwd; quit" || {
            echo "❌ FTP connection failed"
            echo "Please check:"
            echo "1. FTP server address is correct: $FTP_HOST"
            echo "2. FTP port is correct (default: 21, SFTP: 22)"
            echo "3. FTP credentials are correct"
            echo "4. Firewall allows FTP connections from GitHub Actions"
            exit 1
          }
          echo "✅ FTP connection successful"
      
      - name: Create deployment zip package
        run: |
          echo "Creating deployment zip package..."
          cd ./artifact
          
          # Create zip file excluding unnecessary files
          zip -r ../deployment.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x "logs/*" \
            -x "cache/*" \
            -x "*.log" \
            -x ".env" \
            -x "node_modules/*" \
            -x "*.md" \
            -x ".DS_Store" \
            -x "*.swp" \
            -x "*.swo" \
            -x "*~" \
            -x "extract.php" \
            -x "deployment.zip" \
            -x "b2c/config/development/*" \
            -x "b2c/config/testing/*"
          
          cd ..
          echo "✅ Zip package created: $(ls -lh deployment.zip | awk '{print $5}')"
      
      - name: Upload zip and extract on server via FTP
        env:
          FTP_HOST: ${{ secrets.PROD_FTP_HOST }}
          FTP_USER: ${{ secrets.PROD_FTP_USER }}
          FTP_PASS: ${{ secrets.PROD_FTP_PASS }}
          FTP_PORT: ${{ secrets.PROD_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.PROD_FTP_PATH || '/public_html' }}
        run: |
          echo "Uploading zip package via FTP..."
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Upload zip file via FTP
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; put deployment.zip; quit"
          
          echo "✅ Zip file uploaded successfully"
          
          # Create PHP extraction script
          cat > extract.php << 'EXTRACT_EOF'
          <?php
          // One-time extraction script - will self-delete after execution
          $zipFile = 'deployment.zip';
          $extractTo = __DIR__;
          
          if (file_exists($zipFile)) {
              $zip = new ZipArchive;
              if ($zip->open($zipFile) === TRUE) {
                  // Extract files
                  $zip->extractTo($extractTo);
                  $zip->close();
                  
                  // Delete zip file
                  @unlink($zipFile);
                  
                  // Self-delete this script
                  $scriptFile = __FILE__;
                  ignore_user_abort(true);
                  @unlink($scriptFile);
                  
                  echo "✅ Extraction completed successfully";
                  exit(0);
              } else {
                  echo "❌ Failed to open zip file";
                  exit(1);
              }
          } else {
              echo "❌ Zip file not found: $zipFile";
              exit(1);
          }
          ?>
          EXTRACT_EOF
          
          # Upload extraction script
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; put extract.php; quit"
          
          echo "✅ Extraction script uploaded"
          
          # Verify file was uploaded
          echo "Verifying files were uploaded..."
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; ls -la deployment.zip extract.php; quit"
          
          # Get domain from secret or use default
          DOMAIN="${PROD_DOMAIN:-traveltechnology.co.in}"
          
          # Try multiple URL formats
          echo "Attempting to trigger extraction..."
          EXTRACTION_URLS=(
            "https://${DOMAIN}/extract.php"
            "http://${DOMAIN}/extract.php"
            "https://www.${DOMAIN}/extract.php"
            "http://www.${DOMAIN}/extract.php"
          )
          
          EXTRACTION_SUCCESS=false
          
          for EXTRACTION_URL in "${EXTRACTION_URLS[@]}"; do
            echo "Trying: $EXTRACTION_URL"
            sleep 2
            
            EXTRACT_OUTPUT=$(curl -s --max-time 60 "$EXTRACTION_URL" 2>&1 || echo "ERROR")
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 "$EXTRACTION_URL" || echo "000")
            
            echo "HTTP Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Extraction completed successfully!"
              echo "Output: $EXTRACT_OUTPUT"
              EXTRACTION_SUCCESS=true
              sleep 3  # Wait for cleanup
              break
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "⚠️  404 - File not found at this URL, trying next..."
              continue
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "⚠️  Connection failed, trying next URL..."
              continue
            else
              echo "⚠️  HTTP $HTTP_CODE: $EXTRACT_OUTPUT"
              # Still try next URL in case this one is wrong
              continue
            fi
          done
          
          if [ "$EXTRACTION_SUCCESS" = false ]; then
            echo ""
            echo "❌ Could not automatically trigger extraction via HTTP"
            echo ""
            echo "Manual extraction required:"
            echo "1. Visit: https://${DOMAIN}/extract.php in your browser"
            echo "2. Or access via FTP and extract manually"
            echo "3. The zip file is at: ${FTP_PATH_FINAL}/deployment.zip"
            echo "4. The extract script is at: ${FTP_PATH_FINAL}/extract.php"
          fi
          
          # Clean up local files
          rm -f deployment.zip extract.php
          
          echo "✅ Deployment process completed"
      
      - name: Health check after deployment
        env:
          DOMAIN: traveltechnology.co.in
        run: |
          echo "Checking website health..."
          sleep 5  # Wait a few seconds for changes to propagate
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$DOMAIN" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "301" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "✅ Website is responding (HTTP $HTTP_CODE)"
          elif [ "$HTTP_CODE" = "500" ]; then
            echo "⚠️  Website returned HTTP 500 error"
            echo "This might indicate a PHP error or configuration issue"
            echo "Please check server logs for more details"
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "⚠️  Could not connect to website (timeout or connection refused)"
          else
            echo "⚠️  Website returned HTTP $HTTP_CODE"
          fi
      
      - name: Clear cache via FTP
        env:
          FTP_HOST: ${{ secrets.PROD_FTP_HOST }}
          FTP_USER: ${{ secrets.PROD_FTP_USER }}
          FTP_PASS: ${{ secrets.PROD_FTP_PASS }}
          FTP_PORT: ${{ secrets.PROD_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.PROD_FTP_PATH || '/public_html' }}
        run: |
          echo "Clearing application cache via FTP..."
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Create lftp script to clear cache
          cat > /tmp/ftp_clear_cache.lftp << EOF
          set ftp:ssl-allow no
          set ssl:verify-certificate no
          set cmd:fail-exit no
          open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST
          cd $FTP_PATH_FINAL
          rm -rf cache/* logs/*.log
          quit
          EOF
          
          lftp -f /tmp/ftp_clear_cache.lftp || echo "⚠️ Cache clearing attempted (may not be supported via FTP)"
          echo "✅ Cache clearing completed"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Production deployment successful"
            echo "FTP Server: ${{ secrets.PROD_FTP_HOST }}"
            echo "Domain: traveltechnology.co.in"
            echo "Commit: ${{ github.sha }}"
          else
            echo "❌ Production deployment failed"
            echo "Please check the logs for details"
          fi
      
      - name: Create deployment tag
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$(date +%Y%m%d-%H%M%S)" -m "Production deployment: ${{ github.sha }}"
          git push origin --tags || echo "Failed to push tags"
