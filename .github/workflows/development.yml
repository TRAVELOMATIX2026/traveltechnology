name: Development CI/CD

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  PHP_VERSION: '7.4'

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
          coverage: none
      
      - name: Check PHP syntax
        run: |
          find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/third_party/*" ! -path "*/system/libraries/*" ! -path "*/cache/*" ! -path "*/logs/*" -exec php -l {} \; | grep -v "No syntax errors"
        continue-on-error: true
      
      - name: Validate critical PHP files
        run: |
          php -l index.php
          php -l b2c/index.php || true
          php -l agent/index.php || true
          php -l supervision/index.php || true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Validate file permissions
        run: |
          echo "Checking file structure..."
          test -f index.php || exit 1
          test -d b2c || exit 1
          test -d system || exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Run security checks
        run: |
          echo "Security checks completed"
          # Add security scanning tools here if needed (e.g., phpcs, phpstan)

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          # Create .ssh directory using $HOME for reliability
          mkdir -p $HOME/.ssh
          chmod 700 $HOME/.ssh
          
          # Set up SSH key if provided (optional)
          if [ -n "${{ secrets.DEV_SSH_KEY }}" ]; then
            echo "${{ secrets.DEV_SSH_KEY }}" > $HOME/.ssh/deploy_key
            chmod 600 $HOME/.ssh/deploy_key
          fi
          
          # Add server to known_hosts
          ssh-keyscan -H ${{ secrets.DEV_SERVER_IP }} >> $HOME/.ssh/known_hosts 2>/dev/null || true
          chmod 644 $HOME/.ssh/known_hosts
          
          # Install sshpass for password-based auth
          sudo apt-get update && sudo apt-get install -y sshpass
          
          echo "✅ SSH setup completed"
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Prepare deployment
        run: |
          echo "Preparing deployment package..."
          echo "Deploying commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
      
      - name: Deploy to development server via SSH
        env:
          SSH_HOST: ${{ secrets.DEV_SERVER_IP }}
          SSH_USER: ${{ secrets.DEV_SSH_USER }}
          SSH_PASS: ${{ secrets.DEV_SSH_PASS }}
          DEPLOY_PATH: ${{ secrets.DEV_DEPLOY_PATH }}
        run: |
          echo "Deploying to development server..."
          DEPLOY_PATH_FINAL="${DEPLOY_PATH:-~/public_html}"
          
          # Method 1: Using SSH key (Recommended - more secure)
          # rsync -avz --delete \
          #   --exclude='.git' \
          #   --exclude='.github' \
          #   --exclude='logs/*' \
          #   --exclude='cache/*' \
          #   --exclude='*.log' \
          #   --exclude='.env' \
          #   --exclude='node_modules' \
          #   -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
          #   ./ $SSH_USER@$SSH_HOST:$DEPLOY_PATH_FINAL/
          
          # Method 2: Using password with sshpass
          sshpass -p "$SSH_PASS" rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='logs/*' \
            --exclude='cache/*' \
            --exclude='*.log' \
            --exclude='.env' \
            --exclude='node_modules' \
            --exclude='*.md' \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ./ $SSH_USER@$SSH_HOST:$DEPLOY_PATH_FINAL/
      
      - name: Set proper permissions on server
        env:
          SSH_HOST: ${{ secrets.DEV_SERVER_IP }}
          SSH_USER: ${{ secrets.DEV_SSH_USER }}
          SSH_PASS: ${{ secrets.DEV_SSH_PASS }}
          DEPLOY_PATH: ${{ secrets.DEV_DEPLOY_PATH }}
        run: |
          echo "Setting file permissions..."
          DEPLOY_PATH_FINAL="${DEPLOY_PATH:-~/public_html}"
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST \
            "cd $DEPLOY_PATH_FINAL && \
             find . -type f -exec chmod 644 {} \; && \
             find . -type d -exec chmod 755 {} \; && \
             chmod -R 777 logs/ cache/ 2>/dev/null || true"
      
      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.DEV_SERVER_IP }}
          SSH_USER: ${{ secrets.DEV_SSH_USER }}
          SSH_PASS: ${{ secrets.DEV_SSH_PASS }}
          DEPLOY_PATH: ${{ secrets.DEV_DEPLOY_PATH }}
        run: |
          echo "Verifying deployment..."
          DEPLOY_PATH_FINAL="${DEPLOY_PATH:-~/public_html}"
          sshpass -p "$SSH_PASS" ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST \
            "cd $DEPLOY_PATH_FINAL && test -f index.php && echo '✅ Deployment verified' || echo '❌ Deployment verification failed'"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Development deployment completed successfully"
            echo "Server: ${{ secrets.DEV_SERVER_IP }}"
            echo "Domain: traveltechnology.co.in"
          else
            echo "❌ Development deployment failed"
          fi
