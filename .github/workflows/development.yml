name: Development CI/CD

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  PHP_VERSION: '8.2'

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
          coverage: none
      
      - name: Check PHP syntax
        run: |
          find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/third_party/*" ! -path "*/system/libraries/*" ! -path "*/cache/*" ! -path "*/logs/*" -exec php -l {} \; | grep -v "No syntax errors"
        continue-on-error: true
      
      - name: Validate critical PHP files
        run: |
          php -l index.php
          php -l b2c/index.php || true
          php -l agent/index.php || true
          php -l supervision/index.php || true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Validate file permissions
        run: |
          echo "Checking file structure..."
          test -f index.php || exit 1
          test -d b2c || exit 1
          test -d system || exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Run security checks
        run: |
          echo "Security checks completed"
          # Add security scanning tools here if needed (e.g., phpcs, phpstan)

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup FTP
        run: |
          # Install lftp for FTP/SFTP deployment
          sudo apt-get update && sudo apt-get install -y lftp
          echo "✅ FTP client installed"
      
      - name: Prepare deployment
        run: |
          echo "Preparing deployment..."
          echo "Deploying commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
      
      - name: Test FTP connection
        env:
          FTP_HOST: ${{ secrets.DEV_FTP_HOST }}
          FTP_USER: ${{ secrets.DEV_FTP_USER }}
          FTP_PASS: ${{ secrets.DEV_FTP_PASS }}
          FTP_PORT: ${{ secrets.DEV_FTP_PORT || '21' }}
        run: |
          echo "Testing FTP connection..."
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; pwd; quit" || {
            echo "❌ FTP connection failed"
            exit 1
          }
          echo "✅ FTP connection successful"
      
      - name: Deploy to development server via FTP
        env:
          FTP_HOST: ${{ secrets.DEV_FTP_HOST }}
          FTP_USER: ${{ secrets.DEV_FTP_USER }}
          FTP_PASS: ${{ secrets.DEV_FTP_PASS }}
          FTP_PORT: ${{ secrets.DEV_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.DEV_FTP_PATH || '/public_html' }}
        run: |
          echo "Deploying to development server via FTP (optimized for speed)..."
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Create optimized lftp script for faster deployment
          cat > /tmp/ftp_deploy.lftp << 'EOF'
          # Connection settings
          set ftp:ssl-allow no
          set ssl:verify-certificate no
          set ftp:passive-mode yes
          set ftp:list-options -a
          
          # Performance optimizations
          set cmd:fail-exit yes
          set cmd:interactive no
          
          # Network settings
          set net:timeout 20
          set net:max-retries 2
          set net:reconnect-interval-base 3
          
          # Transfer optimizations (parallel transfers for faster speed)
          set mirror:use-pget-n 10
          set xfer:clobber yes
          EOF
          
          echo "open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST" >> /tmp/ftp_deploy.lftp
          echo "cd $FTP_PATH_FINAL" >> /tmp/ftp_deploy.lftp
          echo "lcd ." >> /tmp/ftp_deploy.lftp
          echo "mirror --reverse --delete --only-newer --exclude-glob=.git --exclude-glob=.github --exclude-glob=logs/* --exclude-glob=cache/* --exclude-glob=*.log --exclude-glob=.env --exclude-glob=node_modules --exclude-glob=*.md . ." >> /tmp/ftp_deploy.lftp
          echo "quit" >> /tmp/ftp_deploy.lftp
          
          echo "Starting FTP deployment..."
          lftp -f /tmp/ftp_deploy.lftp
          echo "✅ FTP deployment completed"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Development deployment completed successfully"
            echo "FTP Server: ${{ secrets.DEV_FTP_HOST }}"
            echo "Domain: traveltechnology.co.in"
          else
            echo "❌ Development deployment failed"
          fi
