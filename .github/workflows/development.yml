name: Development CI/CD

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

env:
  PHP_VERSION: '8.2'

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
          coverage: none
      
      - name: Check PHP syntax
        run: |
          find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/third_party/*" ! -path "*/system/libraries/*" ! -path "*/cache/*" ! -path "*/logs/*" -exec php -l {} \; | grep -v "No syntax errors"
        continue-on-error: true
      
      - name: Validate critical PHP files
        run: |
          php -l index.php
          php -l b2c/index.php || true
          php -l agent/index.php || true
          php -l supervision/index.php || true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Validate file permissions
        run: |
          echo "Checking file structure..."
          test -f index.php || exit 1
          test -d b2c || exit 1
          test -d system || exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Run security checks
        run: |
          echo "Security checks completed"
          # Add security scanning tools here if needed (e.g., phpcs, phpstan)

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup FTP
        run: |
          # Install lftp for FTP/SFTP deployment
          sudo apt-get update && sudo apt-get install -y lftp
          echo "✅ FTP client installed"
      
      - name: Prepare deployment
        run: |
          echo "Preparing deployment..."
          echo "Deploying commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
      
      - name: Test FTP connection
        env:
          FTP_HOST: ${{ secrets.DEV_FTP_HOST }}
          FTP_USER: ${{ secrets.DEV_FTP_USER }}
          FTP_PASS: ${{ secrets.DEV_FTP_PASS }}
          FTP_PORT: ${{ secrets.DEV_FTP_PORT || '21' }}
        run: |
          echo "Testing FTP connection..."
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; pwd; quit" || {
            echo "❌ FTP connection failed"
            exit 1
          }
          echo "✅ FTP connection successful"
      
      - name: Create deployment zip package
        run: |
          echo "Creating deployment zip package..."
          
          # Create zip file excluding unnecessary files
          zip -r deployment.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x "logs/*" \
            -x "cache/*" \
            -x "*.log" \
            -x ".env" \
            -x "node_modules/*" \
            -x "*.md" \
            -x ".DS_Store" \
            -x "*.swp" \
            -x "*.swo" \
            -x "*~" \
            -x "extract.php" \
            -x "deployment.zip"
          
          echo "✅ Zip package created: $(ls -lh deployment.zip | awk '{print $5}')"
      
      - name: Upload zip and extract on server via FTP
        env:
          FTP_HOST: ${{ secrets.DEV_FTP_HOST }}
          FTP_USER: ${{ secrets.DEV_FTP_USER }}
          FTP_PASS: ${{ secrets.DEV_FTP_PASS }}
          FTP_PORT: ${{ secrets.DEV_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.DEV_FTP_PATH || '/public_html' }}
        run: |
          echo "Uploading zip package via FTP..."
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Upload zip file via FTP
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; put deployment.zip; quit"
          
          echo "✅ Zip file uploaded successfully"
          
          # Create PHP extraction script
          cat > extract.php << 'EXTRACT_EOF'
          <?php
          // One-time extraction script - will self-delete after execution
          $zipFile = 'deployment.zip';
          $extractTo = __DIR__;
          
          if (file_exists($zipFile)) {
              $zip = new ZipArchive;
              if ($zip->open($zipFile) === TRUE) {
                  // Extract files
                  $zip->extractTo($extractTo);
                  $zip->close();
                  
                  // Delete zip file
                  @unlink($zipFile);
                  
                  // Self-delete this script
                  $scriptFile = __FILE__;
                  ignore_user_abort(true);
                  @unlink($scriptFile);
                  
                  echo "✅ Extraction completed successfully";
                  exit(0);
              } else {
                  echo "❌ Failed to open zip file";
                  exit(1);
              }
          } else {
              echo "❌ Zip file not found: $zipFile";
              exit(1);
          }
          ?>
          EXTRACT_EOF
          
          # Upload extraction script
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; put extract.php; quit"
          
          echo "✅ Extraction script uploaded"
          
          # Trigger extraction via HTTP
          # Try multiple URL formats
          echo "Triggering extraction..."
          
          # Try with domain or IP
          if [[ "$FTP_HOST" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # It's an IP address, try HTTP
            EXTRACTION_URL="http://${FTP_HOST}/extract.php"
          else
            # It's a domain, try HTTPS first
            EXTRACTION_URL="https://${FTP_HOST}/extract.php"
          fi
          
          HTTP_CODE=$(curl -s -o /tmp/extract_result.txt -w "%{http_code}" --max-time 30 "$EXTRACTION_URL" 2>/dev/null || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            cat /tmp/extract_result.txt
            echo "✅ Extraction completed successfully"
            rm -f /tmp/extract_result.txt
          else
            # Try HTTP if HTTPS failed
            EXTRACTION_URL_HTTP="http://${FTP_HOST}/extract.php"
            HTTP_CODE=$(curl -s -o /tmp/extract_result.txt -w "%{http_code}" --max-time 30 "$EXTRACTION_URL_HTTP" 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              cat /tmp/extract_result.txt
              echo "✅ Extraction completed successfully"
            else
              echo "⚠️  Could not trigger extraction automatically (HTTP $HTTP_CODE)"
              echo "⚠️  Please access extract.php manually via browser or use SSH if available"
            fi
            rm -f /tmp/extract_result.txt
          fi
          
          # Clean up local files
          rm -f deployment.zip extract.php
          
          echo "✅ Deployment process completed"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Development deployment completed successfully"
            echo "FTP Server: ${{ secrets.DEV_FTP_HOST }}"
            echo "Domain: traveltechnology.co.in"
          else
            echo "❌ Development deployment failed"
          fi
