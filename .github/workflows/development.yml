name: Development CI/CD

on:
  push:
    branches:
      - develop

env:
  PHP_VERSION: '8.2'

jobs:
  syntax-check:
    name: PHP Syntax Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
          coverage: none
      
      - name: Check PHP syntax
        run: |
          find . -type f -name "*.php" ! -path "*/vendor/*" ! -path "*/third_party/*" ! -path "*/system/libraries/*" ! -path "*/cache/*" ! -path "*/logs/*" -exec php -l {} \; | grep -v "No syntax errors"
        continue-on-error: true
      
      - name: Validate critical PHP files
        run: |
          php -l index.php
          php -l b2c/index.php || true
          php -l agent/index.php || true
          php -l supervision/index.php || true

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Validate file permissions
        run: |
          echo "Checking file structure..."
          test -f index.php || exit 1
          test -d b2c || exit 1
          test -d system || exit 1

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, gd, xml, zip, pdo, pdo_mysql, redis
      
      - name: Run security checks
        run: |
          echo "Security checks completed"
          # Add security scanning tools here if needed (e.g., phpcs, phpstan)

  deploy-development:
    name: Deploy to Development
    runs-on: ubuntu-latest
    needs: [syntax-check, code-quality]
    if: github.ref == 'refs/heads/develop'
    environment:
      name: development
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup FTP
        run: |
          # Install lftp for FTP/SFTP deployment
          sudo apt-get update && sudo apt-get install -y lftp
          echo "‚úÖ FTP client installed"
      
      - name: Prepare deployment
        run: |
          echo "Preparing deployment..."
          echo "Deploying commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
      
      - name: Update database credentials for development
        env:
          DEV_DB_HOST: ${{ secrets.DEV_DB_HOST || 'localhost' }}
          DEV_DB_USERNAME: ${{ secrets.DEV_DB_USERNAME }}
          DEV_DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }}
          DEV_DB_NAME: ${{ secrets.DEV_DB_NAME }}
        run: |
          echo "Updating database credentials for development deployment..."
          if [ -f "scripts/update-db-credentials.sh" ]; then
            chmod +x scripts/update-db-credentials.sh
            ./scripts/update-db-credentials.sh development
          else
            echo "‚ö†Ô∏è  Database update script not found, skipping credential update"
            echo "Make sure to manually configure database credentials on the server"
          fi
      
      - name: Test FTP connection
        env:
          FTP_HOST: ${{ secrets.DEV_FTP_HOST }}
          FTP_USER: ${{ secrets.DEV_FTP_USER }}
          FTP_PASS: ${{ secrets.DEV_FTP_PASS }}
          FTP_PORT: ${{ secrets.DEV_FTP_PORT || '21' }}
        run: |
          echo "Testing FTP connection..."
          echo "Host: $FTP_HOST"
          echo "Port: $FTP_PORT"
          echo "User: $FTP_USER"
          
          # Test DNS resolution first
          if ! getent hosts "$FTP_HOST" > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  DNS resolution failed for: $FTP_HOST"
            echo "üí° Try using an IP address instead of domain name"
            echo "üí° Or check if the hostname is correct"
          fi
          
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; pwd; quit" || {
            echo "‚ùå FTP connection failed"
            echo "Please check:"
            echo "1. FTP server address is correct: $FTP_HOST"
            echo "2. If using domain name, try IP address instead"
            echo "3. FTP port is correct (default: 21, SFTP: 22)"
            echo "4. FTP credentials are correct"
            echo "5. Firewall allows FTP connections from GitHub Actions"
            exit 1
          }
          echo "‚úÖ FTP connection successful"
      
      - name: Create deployment zip package
        run: |
          echo "Creating deployment zip package..."
          
          # Create zip file excluding unnecessary files
          zip -r deployment.zip . \
            -x "*.git*" \
            -x "*.github*" \
            -x "logs/*" \
            -x "cache/*" \
            -x "*.log" \
            -x ".env" \
            -x "node_modules/*" \
            -x "*.md" \
            -x ".DS_Store" \
            -x "*.swp" \
            -x "*.swo" \
            -x "*~" \
            -x "extract.php" \
            -x "deployment.zip"
          
          echo "‚úÖ Zip package created: $(ls -lh deployment.zip | awk '{print $5}')"
      
      - name: Upload zip and extract on server via FTP
        env:
          FTP_HOST: ${{ secrets.DEV_FTP_HOST }}
          FTP_USER: ${{ secrets.DEV_FTP_USER }}
          FTP_PASS: ${{ secrets.DEV_FTP_PASS }}
          FTP_PORT: ${{ secrets.DEV_FTP_PORT || '21' }}
          FTP_PATH: ${{ secrets.DEV_FTP_PATH || '/' }}
        run: |
          echo "Uploading zip package via FTP..."
          echo "Host: $FTP_HOST"
          echo "Port: $FTP_PORT"
          echo "Path: $FTP_PATH"
          FTP_PATH_FINAL="${FTP_PATH%/}"
          
          # Test DNS resolution before attempting connection
          if ! getent hosts "$FTP_HOST" > /dev/null 2>&1; then
            echo "‚ùå DNS resolution failed for: $FTP_HOST"
            echo "üí° Please update DEV_FTP_HOST secret with:"
            echo "   - An IP address (e.g., 154.221.33.114)"
            echo "   - Or correct domain name (e.g., ftp.dev.traveltechnology.co.in)"
            exit 1
          fi
          
          # Upload zip file via FTP
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; put deployment.zip; quit" || {
            echo "‚ùå FTP upload failed"
            echo "Please verify:"
            echo "1. FTP_HOST is correct (try IP address if domain fails)"
            echo "2. FTP_USER and FTP_PASS are correct"
            echo "3. FTP_PATH exists and is accessible: $FTP_PATH_FINAL"
            exit 1
          }
          
          echo "‚úÖ Zip file uploaded successfully"
          
          # Create PHP extraction script
          cat > extract.php << 'EXTRACT_EOF'
          <?php
          // One-time extraction script - will self-delete after execution
          $zipFile = 'deployment.zip';
          $extractTo = __DIR__;
          
          if (file_exists($zipFile)) {
              $zip = new ZipArchive;
              if ($zip->open($zipFile) === TRUE) {
                  // Extract files
                  $zip->extractTo($extractTo);
                  $zip->close();
                  
                  // Delete zip file
                  @unlink($zipFile);
                  
                  // Self-delete this script
                  $scriptFile = __FILE__;
                  ignore_user_abort(true);
                  @unlink($scriptFile);
                  
                  echo "‚úÖ Extraction completed successfully";
                  exit(0);
              } else {
                  echo "‚ùå Failed to open zip file";
                  exit(1);
              }
          } else {
              echo "‚ùå Zip file not found: $zipFile";
              exit(1);
          }
          ?>
          EXTRACT_EOF
          
          # Upload extraction script
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; put extract.php; quit"
          
          echo "‚úÖ Extraction script uploaded"
          
          # Verify file was uploaded
          echo "Verifying files were uploaded..."
          lftp -e "set ftp:ssl-allow no; set ssl:verify-certificate no; set ftp:passive-mode yes; open -p $FTP_PORT -u $FTP_USER,$FTP_PASS $FTP_HOST; cd $FTP_PATH_FINAL; ls -la deployment.zip extract.php; quit"
          
          # Determine domain - use DEV_DOMAIN secret if set, otherwise try to infer from FTP_HOST
          if [[ "$FTP_HOST" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            # It's an IP address, use default domain
            DOMAIN="${DEV_DOMAIN:-traveltechnology.co.in}"
          else
            # It's a domain, use it or extract base domain
            DOMAIN="${DEV_DOMAIN:-${FTP_HOST#ftp.}}"
          fi
          
          # Try multiple URL formats
          echo "Attempting to trigger extraction..."
          EXTRACTION_URLS=(
            "https://${DOMAIN}/extract.php"
            "http://${DOMAIN}/extract.php"
            "https://www.${DOMAIN}/extract.php"
            "http://www.${DOMAIN}/extract.php"
          )
          
          # If FTP_HOST is IP, also try IP directly
          if [[ "$FTP_HOST" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            EXTRACTION_URLS+=("http://${FTP_HOST}/extract.php")
          fi
          
          EXTRACTION_SUCCESS=false
          
          for EXTRACTION_URL in "${EXTRACTION_URLS[@]}"; do
            echo "Trying: $EXTRACTION_URL"
            sleep 2
            
            EXTRACT_OUTPUT=$(curl -s --max-time 60 "$EXTRACTION_URL" 2>&1 || echo "ERROR")
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 60 "$EXTRACTION_URL" || echo "000")
            
            echo "HTTP Code: $HTTP_CODE"
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Extraction completed successfully!"
              echo "Output: $EXTRACT_OUTPUT"
              EXTRACTION_SUCCESS=true
              sleep 3  # Wait for cleanup
              break
            elif [ "$HTTP_CODE" = "404" ]; then
              echo "‚ö†Ô∏è  404 - File not found at this URL, trying next..."
              continue
            elif [ "$HTTP_CODE" = "000" ]; then
              echo "‚ö†Ô∏è  Connection failed, trying next URL..."
              continue
            else
              echo "‚ö†Ô∏è  HTTP $HTTP_CODE: $EXTRACT_OUTPUT"
              # Still try next URL in case this one is wrong
              continue
            fi
          done
          
          if [ "$EXTRACTION_SUCCESS" = false ]; then
            echo ""
            echo "‚ùå Could not automatically trigger extraction via HTTP"
            echo ""
            echo "Manual extraction required:"
            echo "1. Visit: https://${DOMAIN}/extract.php in your browser"
            echo "2. Or access via FTP and extract manually"
            echo "3. The zip file is at: ${FTP_PATH_FINAL}/deployment.zip"
            echo "4. The extract script is at: ${FTP_PATH_FINAL}/extract.php"
          fi
          
          # Clean up local files
          rm -f deployment.zip extract.php
          
          echo "‚úÖ Deployment process completed"
      
      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Development deployment completed successfully"
            echo "FTP Server: ${{ secrets.DEV_FTP_HOST }}"
            echo "Domain: traveltechnology.co.in"
          else
            echo "‚ùå Development deployment failed"
          fi
